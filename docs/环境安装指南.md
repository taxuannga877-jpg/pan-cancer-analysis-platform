# R 环境安装与配置指南

## ⚠️ 问题说明

错误信息：`Cannot find R for creating R terminal. Change setting r.rterm.linux to R path.`

**原因**: 系统中未安装 R 或 R 路径未正确配置。

---

## 🔧 解决方案

### 方案 1: 在 Linux 上安装 R (推荐)

#### 步骤 1: 安装 R

```bash
# Ubuntu/Debian 系统
sudo apt update
sudo apt install -y r-base r-base-dev

# CentOS/RHEL 系统
sudo yum install epel-release
sudo yum install R

# 验证安装
R --version
```

#### 步骤 2: 安装必需的系统依赖

```bash
# Ubuntu/Debian
sudo apt install -y \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    libfontconfig1-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev

# CentOS/RHEL
sudo yum install -y \
    libcurl-devel \
    openssl-devel \
    libxml2-devel \
    fontconfig-devel \
    harfbuzz-devel \
    fribidi-devel \
    freetype-devel \
    libpng-devel \
    libtiff-devel \
    libjpeg-devel
```

#### 步骤 3: 安装 R 包

```bash
# 启动 R
sudo R

# 在 R 控制台中执行
install.packages(c(
  # 核心包
  "shiny", "shinydashboard", "shinyWidgets",
  "DT", "ggplot2", "plotly", "tidyverse",
  
  # 机器学习包
  "caret", "pROC", "randomForest", "glmnet",
  "gbm", "e1071"
), repos = "https://cloud.r-project.org/")

# 退出 R
quit(save = "no")
```

#### 步骤 4: 测试安装

```bash
cd /root/SurvivalML
Rscript test_liver_cancer_module.R
```

---

### 方案 2: 使用 Docker (最简单)

如果您的系统支持 Docker，这是最快的方式。

#### 步骤 1: 创建 Dockerfile

```bash
cd /root/SurvivalML
cat > Dockerfile << 'EOF'
FROM rocker/shiny:latest

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    && rm -rf /var/lib/apt/lists/*

# 安装 R 包
RUN R -e "install.packages(c(\
    'shiny', 'shinydashboard', 'shinyWidgets', \
    'DT', 'ggplot2', 'plotly', 'tidyverse', \
    'caret', 'pROC', 'randomForest', 'glmnet', \
    'gbm', 'e1071' \
), repos = 'https://cloud.r-project.org/')"

# 设置工作目录
WORKDIR /app

# 暴露端口
EXPOSE 3838

CMD ["R"]
EOF
```

#### 步骤 2: 构建和运行

```bash
# 构建 Docker 镜像
docker build -t liver-cancer-analysis .

# 运行容器（交互式）
docker run -it --rm -v $(pwd):/app liver-cancer-analysis

# 或运行 Shiny 应用
docker run -it --rm -p 3838:3838 \
    -v $(pwd):/app \
    liver-cancer-analysis \
    R -e "shiny::runApp('/app/liver_cancer_shiny_app.R', host='0.0.0.0', port=3838)"
```

然后在浏览器中访问: `http://localhost:3838`

---

### 方案 3: 使用在线 R 环境

如果无法在本地安装，可以使用在线服务：

#### RStudio Cloud (推荐)
1. 访问 https://rstudio.cloud/
2. 创建免费账户
3. 创建新项目
4. 上传所有文件
5. 在线运行脚本

#### Google Colab (R 版本)
1. 访问 https://colab.research.google.com/
2. 创建新笔记本
3. 切换到 R 运行时
4. 上传文件并运行

---

### 方案 4: 配置 VS Code R 扩展 (如果使用 VS Code)

#### 步骤 1: 安装 R

先按照**方案 1**安装 R。

#### 步骤 2: 找到 R 路径

```bash
which R
# 通常输出: /usr/bin/R
```

#### 步骤 3: 配置 VS Code

在 VS Code 中：

1. 打开设置 (Ctrl+,)
2. 搜索 `r.rterm.linux`
3. 设置值为: `/usr/bin/R`

或直接编辑 `settings.json`:

```json
{
    "r.rterm.linux": "/usr/bin/R",
    "r.rpath.linux": "/usr/bin/R",
    "r.bracketedPaste": true
}
```

#### 步骤 4: 安装 VS Code R 扩展

1. 打开扩展市场 (Ctrl+Shift+X)
2. 搜索 "R" (REditorSupport.r)
3. 点击安装

---

## 🚀 快速测试脚本

创建一个简单的测试脚本来验证 R 是否正常工作：

```bash
cd /root/SurvivalML
cat > test_r_installation.sh << 'EOF'
#!/bin/bash

echo "=================================="
echo "R 环境测试脚本"
echo "=================================="

# 检查 R 是否安装
echo -e "\n[1/4] 检查 R 是否安装..."
if command -v R &> /dev/null; then
    echo "✓ R 已安装"
    R --version | head -1
else
    echo "✗ R 未安装"
    echo "请运行: sudo apt install r-base r-base-dev"
    exit 1
fi

# 检查 Rscript
echo -e "\n[2/4] 检查 Rscript..."
if command -v Rscript &> /dev/null; then
    echo "✓ Rscript 可用"
    echo "路径: $(which Rscript)"
else
    echo "✗ Rscript 不可用"
    exit 1
fi

# 测试简单的 R 代码
echo -e "\n[3/4] 测试 R 代码执行..."
Rscript -e "cat('✓ R 代码执行成功\n')"

# 检查关键包
echo -e "\n[4/4] 检查 R 包..."
Rscript -e "
packages <- c('shiny', 'ggplot2', 'caret')
installed <- sapply(packages, function(pkg) {
    if (requireNamespace(pkg, quietly = TRUE)) {
        cat('✓', pkg, '\n')
        return(TRUE)
    } else {
        cat('✗', pkg, '(未安装)\n')
        return(FALSE)
    }
})
if (all(installed)) {
    cat('\n所有关键包都已安装!\n')
} else {
    cat('\n需要安装缺失的包。运行:\n')
    cat('R -e \"install.packages(c(\\'shiny\\', \\'ggplot2\\', \\'caret\\'))\"\\n')
}
"

echo -e "\n=================================="
echo "测试完成!"
echo "=================================="
EOF

chmod +x test_r_installation.sh
./test_r_installation.sh
```

---

## 📦 完整的一键安装脚本

```bash
cd /root/SurvivalML
cat > install_r_environment.sh << 'EOF'
#!/bin/bash

set -e  # 遇到错误立即退出

echo "=================================="
echo "R 环境自动安装脚本"
echo "=================================="

# 检测操作系统
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
else
    echo "无法检测操作系统"
    exit 1
fi

echo "检测到操作系统: $OS"

# 安装 R
echo -e "\n[1/3] 安装 R..."
if [ "$OS" = "ubuntu" ] || [ "$OS" = "debian" ]; then
    sudo apt update
    sudo apt install -y r-base r-base-dev
    
    # 安装系统依赖
    echo "安装系统依赖..."
    sudo apt install -y \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libfontconfig1-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev
        
elif [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
    sudo yum install -y epel-release
    sudo yum install -y R
    
    # 安装系统依赖
    echo "安装系统依赖..."
    sudo yum install -y \
        libcurl-devel \
        openssl-devel \
        libxml2-devel
else
    echo "不支持的操作系统: $OS"
    exit 1
fi

echo "✓ R 安装完成"

# 安装 R 包
echo -e "\n[2/3] 安装 R 包..."
sudo R --vanilla << 'REOF'
# 设置 CRAN 镜像
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# 安装包
packages <- c(
  "shiny", "shinydashboard", "shinyWidgets",
  "DT", "ggplot2", "plotly", "tidyverse",
  "caret", "pROC", "randomForest", "glmnet",
  "gbm", "e1071"
)

cat("开始安装", length(packages), "个 R 包...\n")
install.packages(packages, dependencies = TRUE)

cat("\n检查安装结果:\n")
for (pkg in packages) {
  if (requireNamespace(pkg, quietly = TRUE)) {
    cat("✓", pkg, "\n")
  } else {
    cat("✗", pkg, "安装失败\n")
  }
}

cat("\n所有 R 包安装完成!\n")
REOF

echo "✓ R 包安装完成"

# 测试安装
echo -e "\n[3/3] 测试安装..."
if [ -f "test_liver_cancer_module.R" ]; then
    Rscript test_liver_cancer_module.R
else
    echo "测试脚本不存在，跳过测试"
fi

echo -e "\n=================================="
echo "✓ R 环境安装完成!"
echo "=================================="
echo ""
echo "现在可以运行:"
echo "  Rscript test_liver_cancer_module.R"
echo "  shiny::runApp('liver_cancer_shiny_app.R')"
echo ""
EOF

chmod +x install_r_environment.sh
```

**运行安装脚本：**

```bash
./install_r_environment.sh
```

---

## 🎯 推荐方案选择

| 场景 | 推荐方案 | 难度 | 时间 |
|------|---------|------|------|
| 长期使用，有管理员权限 | **方案 1** (直接安装) | ⭐⭐ | 15-30分钟 |
| 熟悉 Docker | **方案 2** (Docker) | ⭐⭐⭐ | 10-20分钟 |
| 无管理员权限 | **方案 3** (在线环境) | ⭐ | 5分钟 |
| 使用 VS Code | **方案 4** (配置扩展) | ⭐⭐ | 10分钟 |

---

## ✅ 验证安装成功

安装完成后，运行以下命令验证：

```bash
# 1. 检查 R 版本
R --version

# 2. 检查 Rscript
which Rscript

# 3. 运行测试脚本
cd /root/SurvivalML
Rscript test_liver_cancer_module.R

# 4. 如果测试通过，启动 Shiny 应用
R -e "shiny::runApp('liver_cancer_shiny_app.R')"
```

如果所有命令都成功执行，说明环境配置完成！

---

## 🐛 常见问题

### Q1: 安装包时提示权限不足

**解决方案：**
```bash
# 方法 1: 使用 sudo
sudo R -e "install.packages('shiny')"

# 方法 2: 安装到用户目录
R -e "install.packages('shiny', lib='~/R/library')"
```

### Q2: 安装包时报错缺少系统依赖

**解决方案：**
```bash
# 根据错误信息安装对应的 -dev 包
# 例如缺少 libcurl
sudo apt install libcurl4-openssl-dev

# 或查看完整的依赖列表
sudo apt install -y \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    libfontconfig1-dev
```

### Q3: Docker 安装很慢

**解决方案：**
```bash
# 使用国内镜像源
# 编辑 /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}

# 重启 Docker
sudo systemctl restart docker
```

---

## 📞 获取帮助

如果遇到问题：

1. 📧 Email: liuzaoqu@163.com
2. 🔍 查看详细错误信息
3. 📚 参考 R 官方文档: https://www.r-project.org/

---

**祝您安装顺利！安装完成后即可开始使用肝癌数据分析模块。** 🚀

