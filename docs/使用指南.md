# 🚀 肝癌数据分析高级版 - 使用指南

## 📋 新增高级功能

### ✨ **版本对比**

| 功能 | 基础版 | 高级版 |
|------|--------|--------|
| 基础模型训练 | ✅ | ✅ |
| **K折交叉验证** | ❌ | ✅ |
| **贝叶斯超参数优化** | ❌ | ✅ |
| **过拟合检测** | ❌ | ✅ |
| **模型保存/加载** | ❌ | ✅ |
| **SHAP可解释性分析** | ❌ | ✅ |
| **部分依赖图(PDP)** | ❌ | ✅ |
| **学习曲线** | ❌ | ✅ |
| **XGBoost算法** | ❌ | ✅ |

---

## 🚀 启动高级版应用

```bash
cd /root/SurvivalML

# 先停止基础版（如果在运行）
pkill -f "shiny::runApp"

# 启动高级版
R -e "shiny::runApp('liver_cancer_advanced_app.R', host='0.0.0.0', port=3838)"
```

访问地址: `http://localhost:3838`

---

## 📚 高级功能详解

### 1️⃣ **K折交叉验证**

#### **什么是K折交叉验证？**
将数据分成K份，轮流使用其中一份作为验证集，其余作为训练集，重复K次。这样可以更准确地评估模型的泛化能力。

#### **使用方法**
在"高级模型训练"页面：
1. 选择交叉验证方法：
   - **K折交叉验证**: 标准方法，K默认为5
   - **重复K折**: 重复多次K折验证，更稳定
   - **留一法(LOOCV)**: 样本量小时使用

2. 设置K折数（3-10折）
3. 如选择重复K折，设置重复次数（2-10次）

#### **结果解读**
- **CV_AUC**: 交叉验证的平均AUC，反映模型真实能力
- **Test_AUC**: 测试集AUC
- **Overfit_Gap**: 两者差值，检测过拟合
  - < 0.05: 低过拟合 ✓
  - 0.05-0.1: 中等过拟合 ⚠
  - \> 0.1: 高过拟合 ⚠⚠

---

### 2️⃣ **贝叶斯超参数优化**

#### **什么是贝叶斯优化？**
自动搜索最佳超参数的智能方法，比网格搜索更高效。

#### **使用方法**
1. 勾选"使用贝叶斯优化"
2. 设置优化迭代次数（5-50次）
   - 5-10次: 快速试验
   - 20-30次: 平衡性能与时间
   - 40-50次: 追求最优性能

3. 训练完成后，系统会自动使用最优参数

#### **支持的模型**
- Random Forest (mtry)
- GBM (n.trees, interaction.depth, shrinkage)
- Elastic Net (alpha, lambda)

---

### 3️⃣ **过拟合防止**

#### **早停法 (Early Stopping)**
监控验证集性能，当性能不再提升时自动停止训练。

**使用方法:**
- 勾选"早停法"复选框
- 适用于GBM、XGBoost等迭代算法

#### **L1/L2 正则化**
添加惩罚项防止模型过于复杂。

**使用方法:**
- 勾选"L1/L2 正则化"
- Lasso(L1)、Ridge(L2)、Elastic Net(L1+L2)会自动应用

#### **过拟合检测图**
训练完成后自动生成，对比CV和测试集性能：
- 柱子高度相近: 无过拟合 ✓
- CV明显高于Test: 过拟合 ⚠

---

### 4️⃣ **模型保存与管理**

#### **保存模型**
在"模型管理"页面：
1. 选择要保存的模型
2. 输入模型名称（如：liver_rf_best）
3. 点击"保存模型"
4. 模型保存到 `saved_models/` 目录

**保存内容:**
- 训练好的模型
- 性能指标
- 训练参数
- 时间戳

#### **加载模型**
1. 点击"刷新列表"查看已保存模型
2. 选择要加载的模型
3. 点击"加载模型"
4. 加载后可用于预测

#### **模型文件管理**
- 文件格式: `.rds`
- 存储位置: `/root/SurvivalML/saved_models/`
- 文件命名: `模型名_时间戳.rds`
- 可复制文件用于模型部署

---

### 5️⃣ **SHAP 可解释性分析**

#### **什么是SHAP？**
SHAP (SHapley Additive exPlanations) 是一种解释模型预测的方法，显示每个特征对预测的贡献。

#### **使用步骤**
在"可解释性分析"页面：

1. **计算SHAP值**
   - 选择要分析的模型
   - 设置分析样本数（10-100）
   - 点击"计算 SHAP 值"

2. **查看SHAP特征重要性**
   - 柱状图显示Top 10重要特征
   - 重要性越高，对预测影响越大

3. **查看SHAP摘要图**
   - 可视化所有特征的重要性
   - 颜色表示特征值高低

4. **SHAP依赖图**
   - 选择特征查看其与目标的关系
   - 密度图显示不同类别的分布

#### **结果解读**
- **重要性高的特征**: 关键诊断指标，需重点关注
- **依赖图中的分离**: 特征区分良恶性的能力
- **正值SHAP**: 增加恶性概率
- **负值SHAP**: 降低恶性概率

---

### 6️⃣ **部分依赖图 (PDP)**

#### **什么是PDP？**
显示特定特征变化时，模型预测如何变化，其他特征保持不变。

#### **使用方法**
1. 在"可解释性分析"页面
2. 选择要分析的特征
3. 自动生成PDP曲线

#### **解读示例**
- **上升曲线**: 特征值增加，恶性概率增加
- **下降曲线**: 特征值增加，恶性概率减少
- **平缓曲线**: 该特征影响较小
- **非线性**: 复杂的关系

---

### 7️⃣ **学习曲线**

#### **作用**
显示模型训练过程中性能的变化，帮助判断：
- 是否收敛
- 是否需要更多数据
- 参数是否合适

#### **查看位置**
"模型评估" → "学习曲线 (最佳模型)"

#### **解读**
- **上升后平稳**: 正常，模型已收敛
- **持续上升**: 可能需要更多训练
- **下降**: 过拟合，需要正则化
- **震荡**: 学习率可能太大

---

## 🎯 完整工作流程示例

### **场景：训练高性能肝癌诊断模型**

#### **步骤1: 数据准备**
```
1. 打开应用 → "数据概览"
2. 点击"加载默认肝癌数据"
3. 查看数据统计，确认3243条记录
```

#### **步骤2: 特征分析**
```
1. 切换到"特征分析"
2. 查看相关性热图，识别相关特征
3. 选择不同特征查看分布
```

#### **步骤3: 高级训练**
```
1. 切换到"高级模型训练"

2. 设置参数:
   - 训练集比例: 0.7
   - 交叉验证: 5折交叉验证
   - ✓ 使用贝叶斯优化 (20次迭代)
   - ✓ 早停法
   - ✓ 正则化

3. 选择算法:
   - ✓ Random Forest
   - ✓ GBM
   - ✓ XGBoost
   - ✓ Elastic Net

4. 点击"开始训练模型"
5. 等待3-5分钟
6. 查看过拟合检测图
```

#### **步骤4: 模型评估**
```
1. 切换到"模型评估"
2. 查看交叉验证性能表
3. 对比ROC曲线
4. 检查混淆矩阵
5. 查看学习曲线
```

#### **步骤5: 可解释性分析**
```
1. 切换到"可解释性分析"
2. 选择最佳模型（如Random Forest）
3. 设置50个样本
4. 点击"计算 SHAP 值"
5. 查看特征重要性排名
6. 选择Top特征查看依赖图
7. 查看PDP了解特征影响
```

#### **步骤6: 保存模型**
```
1. 切换到"模型管理"
2. 选择最佳模型
3. 输入名称: liver_rf_production_v1
4. 点击"保存模型"
5. 记录保存路径
```

#### **步骤7: 预测新样本**
```
1. 切换到"预测分析"
2. 输入患者12项指标
3. 选择已保存的模型
4. ✓ 显示 SHAP 解释
5. 点击"进行预测"
6. 查看风险等级和建议
7. 查看SHAP解释了解原因
```

---

## 📊 性能优化建议

### **训练速度 vs 性能**

| 设置 | 速度 | 性能 | 推荐场景 |
|------|------|------|---------|
| 3折CV, 无优化 | 快 | 中 | 快速试验 |
| 5折CV, 贝叶斯10次 | 中 | 高 | 日常使用 ✓ |
| 10折重复3次, 贝叶斯50次 | 慢 | 最高 | 生产部署 |

### **样本量建议**

| 样本数 | 推荐K折 | SHAP样本 | 备注 |
|--------|---------|----------|------|
| < 100 | 5折或LOOCV | 20-30 | 小数据集 |
| 100-1000 | 5-10折 | 50 | 中等数据 |
| \> 1000 | 5折 | 100 | 大数据集 ✓ |

---

## 🔍 常见问题

### Q1: 交叉验证AUC明显高于测试集AUC？
**A**: 这是过拟合的信号。解决方法：
1. 增强正则化
2. 减少模型复杂度
3. 增加训练数据
4. 使用早停法

### Q2: 贝叶斯优化很慢怎么办？
**A**: 
- 减少迭代次数（如从50降到10）
- 先用较少折数（3折）
- 减少候选算法数量
- 使用更快的算法（如Lasso）

### Q3: SHAP计算失败？
**A**: 
- 确保模型已训练完成
- 减少分析样本数
- 某些简单模型用特征重要性代替

### Q4: 模型保存后在哪里？
**A**: `/root/SurvivalML/saved_models/` 目录
- 可以复制`.rds`文件到其他地方
- 使用`readRDS()`加载到R中

### Q5: 如何选择最佳模型？
**A**: 综合考虑：
1. **CV AUC** (主要指标)
2. **过拟合程度** (越小越好)
3. **可解释性** (医疗场景重要)
4. **预测速度** (实时应用考虑)

推荐: Random Forest 或 GBM + 正则化

---

## 📈 进阶技巧

### **1. 集成学习**
```
训练多个不同的模型，然后:
1. 保存所有高性能模型
2. 预测时取平均值
3. 通常比单个模型更稳定
```

### **2. 特征工程**
```
根据SHAP分析结果:
1. 删除不重要的特征
2. 组合重要特征
3. 添加交互项
4. 重新训练模型
```

### **3. 阈值优化**
```
默认阈值0.5可能不是最优:
1. 查看ROC曲线
2. 根据业务需求调整
3. 医疗场景可能用0.3(高敏感度)
```

### **4. 批量预测**
```r
# 加载保存的模型
model <- readRDS("saved_models/liver_rf_production_v1_xxx.rds")

# 批量读取数据
new_patients <- read.csv("new_patients.csv")

# 批量预测
predictions <- predict(model$model, new_patients, type = "prob")

# 保存结果
results <- data.frame(
  patient_id = new_patients$id,
  risk_score = predictions[, 2],
  risk_level = ifelse(predictions[, 2] > 0.7, "高", 
                     ifelse(predictions[, 2] > 0.3, "中", "低"))
)

write.csv(results, "prediction_results.csv")
```

---

## 🎓 学习资源

### **了解更多**
- K折交叉验证: [Cross-Validation Explained](https://scikit-learn.org/stable/modules/cross_validation.html)
- 贝叶斯优化: [Bayesian Optimization](https://github.com/fmfn/BayesianOptimization)
- SHAP值: [SHAP Documentation](https://shap.readthedocs.io/)
- 过拟合: [Overfitting in Machine Learning](https://en.wikipedia.org/wiki/Overfitting)

---

## 📞 技术支持

- **Email**: liuzaoqu@163.com
- **文档**: 查看同目录下其他指南
- **问题反馈**: GitHub Issues

---

**祝您使用愉快！通过高级功能构建更准确、更可靠的医疗诊断模型！** 🚀

